<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è°ƒæ•´ä¸è£å‰ªå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
            margin-bottom: 30px;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .main-content.active {
                grid-template-columns: 1fr;
            }
        }

        .preview-area {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: auto;
        }

        .canvas-wrapper {
            position: relative;
            display: inline-block;
        }

        #imageCanvas {
            display: block;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 100%;
            height: auto;
        }

        .control-panel {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
        }

        .control-section h3::before {
            content: 'â–¸';
            margin-right: 8px;
            font-size: 14px;
        }

        .preset-sizes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .preset-btn {
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
        }

        .preset-btn:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .preset-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-unit {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 12px;
            pointer-events: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .format-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .format-btn {
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .format-btn:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .format-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .crop-overlay {
            position: absolute;
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
            cursor: move;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .crop-handle {
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #667eea;
            position: absolute;
            border-radius: 50%;
        }

        .crop-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .crop-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .crop-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .crop-handle.n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }
        .crop-handle.s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }
        .crop-handle.w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }
        .crop-handle.e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }

        .error-message.show {
            display: block;
        }

        .mode-switch {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 600;
        }

        .mode-btn:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .mode-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .warning-text {
            font-size: 12px;
            color: #ff9800;
            margin-top: 5px;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }

        .success-message.show {
            display: block;
        }

        .crop-info {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–¼ï¸ å›¾ç‰‡è°ƒæ•´ä¸è£å‰ªå·¥å…·</h1>
            <p>æ”¯æŒPNGã€JPEGã€WebPæ ¼å¼ | å¤šæ¬¡è°ƒæ•´è£å‰ª | æ‰€è§å³æ‰€å¾—</p>
        </div>

        <div class="content">
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ–¼ï¸</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</h3>
                <p>æ”¯æŒ PNGã€JPGã€JPEGã€WebP æ ¼å¼</p>
                <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/webp">
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="main-content" id="mainContent">
                <!-- é¢„è§ˆåŒº -->
                <div class="preview-area">
                    <div class="canvas-wrapper" id="canvasWrapper">
                        <canvas id="imageCanvas"></canvas>
                        <div class="crop-overlay" id="cropOverlay" style="display: none;">
                            <div class="crop-handle nw"></div>
                            <div class="crop-handle n"></div>
                            <div class="crop-handle ne"></div>
                            <div class="crop-handle w"></div>
                            <div class="crop-handle e"></div>
                            <div class="crop-handle sw"></div>
                            <div class="crop-handle s"></div>
                            <div class="crop-handle se"></div>
                        </div>
                    </div>
                    <div class="crop-info" id="cropInfo" style="display: none;"></div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <!-- æ¨¡å¼åˆ‡æ¢ -->
                    <div class="mode-switch">
                        <button class="mode-btn active" data-mode="resize" onclick="switchMode('resize')">
                            ğŸ“ è°ƒæ•´å¤§å°
                        </button>
                        <button class="mode-btn" data-mode="crop" onclick="switchMode('crop')">
                            âœ‚ï¸ è£å‰ª
                        </button>
                    </div>

                    <!-- å›¾ç‰‡ä¿¡æ¯ -->
                    <div class="control-section">
                        <h3>å›¾ç‰‡ä¿¡æ¯</h3>
                        <div class="info-box">
                            <div class="info-item">
                                <span class="info-label">å½“å‰å°ºå¯¸</span>
                                <span class="info-value" id="currentSize">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">é¢„ä¼°å¤§å°</span>
                                <span class="info-value" id="fileSize">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- è°ƒæ•´å¤§å°è®¾ç½® -->
                    <div class="control-section" id="resizeSection">
                        <h3>å°ºå¯¸è®¾ç½®</h3>
                        
                        <!-- é¢„è®¾å°ºå¯¸ -->
                        <div class="preset-sizes">
                            <button class="preset-btn" onclick="applyPreset(1920, 1080)">1920Ã—1080</button>
                            <button class="preset-btn" onclick="applyPreset(1280, 720)">1280Ã—720</button>
                            <button class="preset-btn" onclick="applyPreset(800, 600)">800Ã—600</button>
                            <button class="preset-btn" onclick="applyPreset(640, 480)">640Ã—480</button>
                            <button class="preset-btn" onclick="applyPreset(512, 512)">512Ã—512</button>
                            <button class="preset-btn" onclick="applyPreset(256, 256)">256Ã—256</button>
                        </div>

                        <!-- è‡ªå®šä¹‰å°ºå¯¸ -->
                        <div class="input-group">
                            <label>è‡ªå®šä¹‰å°ºå¯¸</label>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="widthInput" placeholder="å®½åº¦" min="1">
                                    <span class="input-unit">px</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="heightInput" placeholder="é«˜åº¦" min="1">
                                    <span class="input-unit">px</span>
                                </div>
                            </div>
                        </div>

                        <!-- æœ€å¤§å°ºå¯¸é™åˆ¶ -->
                        <div class="input-group">
                            <label>æœ€å¤§å°ºå¯¸é™åˆ¶ï¼ˆå¯é€‰ï¼‰</label>
                            <div class="input-row">
                                <div class="input-wrapper">
                                    <input type="number" id="maxWidthInput" placeholder="æœ€å¤§å®½" min="1">
                                    <span class="input-unit">px</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="maxHeightInput" placeholder="æœ€å¤§é«˜" min="1">
                                    <span class="input-unit">px</span>
                                </div>
                            </div>
                            <p class="warning-text">* å›¾ç‰‡ä¸ä¼šè¶…è¿‡æ­¤å°ºå¯¸ï¼Œä¿æŒæ¯”ä¾‹ç¼©æ”¾</p>
                        </div>

                        <!-- ä¿æŒæ¯”ä¾‹ -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="keepRatio" checked>
                            <label for="keepRatio">ä¿æŒå®½é«˜æ¯”</label>
                        </div>

                        <button class="btn btn-success" onclick="applyResize()">âœ… åº”ç”¨è°ƒæ•´</button>
                    </div>

                    <!-- è£å‰ªè®¾ç½® -->
                    <div class="control-section" id="cropSection" style="display: none;">
                        <h3>è£å‰ªè®¾ç½®</h3>
                        
                        <!-- è£å‰ªæ¯”ä¾‹ -->
                        <div class="input-group">
                            <label>è£å‰ªæ¯”ä¾‹</label>
                            <div class="preset-sizes">
                                <button class="preset-btn active" onclick="setCropRatio('free')">è‡ªç”±</button>
                                <button class="preset-btn" onclick="setCropRatio(1)">1:1</button>
                                <button class="preset-btn" onclick="setCropRatio(16/9)">16:9</button>
                                <button class="preset-btn" onclick="setCropRatio(4/3)">4:3</button>
                                <button class="preset-btn" onclick="setCropRatio(3/2)">3:2</button>
                                <button class="preset-btn" onclick="setCropRatio(9/16)">9:16</button>
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="resetCrop()">ğŸ”„ é‡ç½®è£å‰ªåŒºåŸŸ</button>
                        <button class="btn btn-success" onclick="applyCrop()">âœ… åº”ç”¨è£å‰ª</button>
                    </div>

                    <!-- è´¨é‡è®¾ç½® -->
                    <div class="control-section">
                        <h3>å¯¼å‡ºè®¾ç½®</h3>
                        
                        <!-- æ ¼å¼é€‰æ‹© -->
                        <div class="input-group">
                            <label>è¾“å‡ºæ ¼å¼</label>
                            <div class="format-group">
                                <button class="format-btn active" data-format="png" onclick="selectFormat('png')">PNG</button>
                                <button class="format-btn" data-format="jpeg" onclick="selectFormat('jpeg')">JPEG</button>
                            </div>
                        </div>

                        <!-- è´¨é‡æ»‘å—ï¼ˆä»…JPEGï¼‰ -->
                        <div class="slider-group" id="qualitySlider" style="display: none;">
                            <label>
                                <span>å›¾ç‰‡è´¨é‡</span>
                                <span id="qualityValue">90%</span>
                            </label>
                            <input type="range" id="quality" min="1" max="100" value="90" oninput="updateQuality(this.value)">
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="control-section">
                        <button class="btn btn-primary" onclick="downloadImage()">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                        <button class="btn btn-secondary" onclick="resetAll()">ğŸ”„ é‡æ–°ä¸Šä¼ </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentImage = null;
        let currentCanvas = null;
        let ctx = null;
        let currentMode = 'resize';
        let outputFormat = 'png';
        let quality = 0.9;
        let currentWidth = 0;
        let currentHeight = 0;
        
        // è£å‰ªç›¸å…³
        let cropBox = {
            x: 0,
            y: 0,
            width: 0,
            height: 0
        };
        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let cropRatio = 'free';
        let canvasScale = 1; // Canvasæ˜¾ç¤ºç¼©æ”¾æ¯”ä¾‹

        // åˆå§‹åŒ–
        document.getElementById('uploadSection').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // å°ºå¯¸è¾“å…¥è”åŠ¨
        document.getElementById('widthInput').addEventListener('input', (e) => {
            if (document.getElementById('keepRatio').checked && currentImage) {
                const width = parseInt(e.target.value) || 0;
                const height = Math.round(width * currentHeight / currentWidth);
                document.getElementById('heightInput').value = height;
            }
        });

        document.getElementById('heightInput').addEventListener('input', (e) => {
            if (document.getElementById('keepRatio').checked && currentImage) {
                const height = parseInt(e.target.value) || 0;
                const width = Math.round(height * currentWidth / currentHeight);
                document.getElementById('widthInput').value = width;
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            handleFile(file);
        }

        function handleFile(file) {
            if (!file || !file.type.match('image/(png|jpeg|jpg|webp)')) {
                showError('è¯·é€‰æ‹©PNGã€JPEGæˆ–WebPæ ¼å¼çš„å›¾ç‰‡');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    currentWidth = img.width;
                    currentHeight = img.height;
                    initializeCanvas();
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('mainContent').classList.add('active');
                    showSuccess('å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function initializeCanvas() {
            currentCanvas = document.getElementById('imageCanvas');
            ctx = currentCanvas.getContext('2d');
            
            // è®¾ç½®åˆå§‹å°ºå¯¸
            document.getElementById('widthInput').value = currentWidth;
            document.getElementById('heightInput').value = currentHeight;
            
            drawCurrentImage();
            updateInfo();
            initializeCropEvents();
        }

        function drawCurrentImage() {
            currentCanvas.width = currentWidth;
            currentCanvas.height = currentHeight;
            ctx.clearRect(0, 0, currentWidth, currentHeight);
            ctx.drawImage(currentImage, 0, 0, currentWidth, currentHeight);
            updateInfo();
        }

        function updateInfo() {
            document.getElementById('currentSize').textContent = `${currentWidth} Ã— ${currentHeight}`;
            
            // ä¼°ç®—æ–‡ä»¶å¤§å°
            currentCanvas.toBlob((blob) => {
                if (blob) {
                    const size = (blob.size / 1024).toFixed(2);
                    document.getElementById('fileSize').textContent = size + ' KB';
                }
            }, outputFormat === 'jpeg' ? 'image/jpeg' : 'image/png', quality);
        }

        function applyPreset(width, height) {
            if (!currentImage) return;

            // æ ¹æ®ä¿æŒæ¯”ä¾‹è®¾ç½®è°ƒæ•´å°ºå¯¸
            if (document.getElementById('keepRatio').checked) {
                const ratio = Math.min(width / currentWidth, height / currentHeight);
                width = Math.round(currentWidth * ratio);
                height = Math.round(currentHeight * ratio);
            }

            document.getElementById('widthInput').value = width;
            document.getElementById('heightInput').value = height;
        }

        function applyResize() {
            if (!currentImage) {
                showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            let width = parseInt(document.getElementById('widthInput').value);
            let height = parseInt(document.getElementById('heightInput').value);

            if (!width || !height || width < 1 || height < 1) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„å®½åº¦å’Œé«˜åº¦');
                return;
            }

            // åº”ç”¨æœ€å¤§å°ºå¯¸é™åˆ¶
            const maxWidth = parseInt(document.getElementById('maxWidthInput').value);
            const maxHeight = parseInt(document.getElementById('maxHeightInput').value);

            if (maxWidth && maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
                if (ratio < 1) {
                    width = Math.round(width * ratio);
                    height = Math.round(height * ratio);
                    document.getElementById('widthInput').value = width;
                    document.getElementById('heightInput').value = height;
                }
            } else if (maxWidth && width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = Math.round(height * ratio);
                document.getElementById('widthInput').value = width;
                document.getElementById('heightInput').value = height;
            } else if (maxHeight && height > maxHeight) {
                const ratio = maxHeight / height;
                height = maxHeight;
                width = Math.round(width * ratio);
                document.getElementById('widthInput').value = width;
                document.getElementById('heightInput').value = height;
            }

            // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œç¼©æ”¾
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(currentImage, 0, 0, width, height);

            // å°†ç¼©æ”¾åçš„å›¾ç‰‡è½¬ä¸ºæ–°çš„Imageå¯¹è±¡
            tempCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    currentWidth = width;
                    currentHeight = height;
                    drawCurrentImage();
                    URL.revokeObjectURL(url);
                    showSuccess('å°ºå¯¸è°ƒæ•´å·²åº”ç”¨ï¼');
                };
                img.src = url;
            });
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // åˆ‡æ¢é¢æ¿
            if (mode === 'resize') {
                document.getElementById('resizeSection').style.display = 'block';
                document.getElementById('cropSection').style.display = 'none';
                document.getElementById('cropOverlay').style.display = 'none';
                document.getElementById('cropInfo').style.display = 'none';
            } else {
                document.getElementById('resizeSection').style.display = 'none';
                document.getElementById('cropSection').style.display = 'block';
                document.getElementById('cropOverlay').style.display = 'block';
                resetCrop();
            }
        }

        // è£å‰ªåŠŸèƒ½
        function initializeCropEvents() {
            const overlay = document.getElementById('cropOverlay');
            const handles = overlay.querySelectorAll('.crop-handle');

            overlay.addEventListener('mousedown', startDrag);
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', stopDragResize);
        }

        function resetCrop() {
            if (!currentImage) return;
            
            const padding = 20;
            const maxWidth = Math.min(currentWidth - padding * 2, currentWidth * 0.8);
            const maxHeight = Math.min(currentHeight - padding * 2, currentHeight * 0.8);
            
            cropBox = {
                x: (currentWidth - maxWidth) / 2,
                y: (currentHeight - maxHeight) / 2,
                width: maxWidth,
                height: maxHeight
            };
            
            updateCropOverlay();
        }

        function setCropRatio(ratio) {
            cropRatio = ratio;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#cropSection .preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (ratio !== 'free') {
                // æ ¹æ®æ¯”ä¾‹è°ƒæ•´è£å‰ªæ¡†
                const centerX = cropBox.x + cropBox.width / 2;
                const centerY = cropBox.y + cropBox.height / 2;
                
                if (cropBox.width / cropBox.height > ratio) {
                    cropBox.width = cropBox.height * ratio;
                } else {
                    cropBox.height = cropBox.width / ratio;
                }
                
                // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
                if (cropBox.width > currentWidth) {
                    cropBox.width = currentWidth;
                    cropBox.height = cropBox.width / ratio;
                }
                if (cropBox.height > currentHeight) {
                    cropBox.height = currentHeight;
                    cropBox.width = cropBox.height * ratio;
                }
                
                cropBox.x = Math.max(0, Math.min(centerX - cropBox.width / 2, currentWidth - cropBox.width));
                cropBox.y = Math.max(0, Math.min(centerY - cropBox.height / 2, currentHeight - cropBox.height));
                
                updateCropOverlay();
            }
        }

        function startDrag(e) {
            if (e.target.classList.contains('crop-handle')) return;
            isDragging = true;
            const rect = currentCanvas.getBoundingClientRect();
            dragStartX = e.clientX - rect.left - cropBox.x;
            dragStartY = e.clientY - rect.top - cropBox.y;
            e.preventDefault();
        }

        function startResize(e) {
            e.stopPropagation();
            e.preventDefault();
            isResizing = true;
            resizeHandle = e.target.className.split(' ')[1];
            dragStartX = e.clientX;
            dragStartY = e.clientY;
        }

        function onMouseMove(e) {
            if (!isDragging && !isResizing) return;

            const rect = currentCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (isDragging) {
                cropBox.x = Math.max(0, Math.min(mouseX - dragStartX, currentWidth - cropBox.width));
                cropBox.y = Math.max(0, Math.min(mouseY - dragStartY, currentHeight - cropBox.height));
            } else if (isResizing) {
                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                
                const oldBox = { ...cropBox };
                
                if (resizeHandle.includes('e')) {
                    cropBox.width = Math.max(50, Math.min(cropBox.width + dx, currentWidth - cropBox.x));
                }
                if (resizeHandle.includes('w')) {
                    const newWidth = Math.max(50, cropBox.width - dx);
                    const widthDiff = cropBox.width - newWidth;
                    if (cropBox.x + widthDiff >= 0) {
                        cropBox.x = cropBox.x + widthDiff;
                        cropBox.width = newWidth;
                    }
                }
                if (resizeHandle.includes('s')) {
                    cropBox.height = Math.max(50, Math.min(cropBox.height + dy, currentHeight - cropBox.y));
                }
                if (resizeHandle.includes('n')) {
                    const newHeight = Math.max(50, cropBox.height - dy);
                    const heightDiff = cropBox.height - newHeight;
                    if (cropBox.y + heightDiff >= 0) {
                        cropBox.y = cropBox.y + heightDiff;
                        cropBox.height = newHeight;
                    }
                }

                // å¦‚æœè®¾ç½®äº†æ¯”ä¾‹ï¼Œè°ƒæ•´å°ºå¯¸
                if (cropRatio !== 'free') {
                    if (resizeHandle.includes('e') || resizeHandle.includes('w')) {
                        const newHeight = cropBox.width / cropRatio;
                        if (newHeight <= currentHeight - cropBox.y) {
                            cropBox.height = newHeight;
                        } else {
                            cropBox.height = currentHeight - cropBox.y;
                            cropBox.width = cropBox.height * cropRatio;
                        }
                    } else {
                        const newWidth = cropBox.height * cropRatio;
                        if (newWidth <= currentWidth - cropBox.x) {
                            cropBox.width = newWidth;
                        } else {
                            cropBox.width = currentWidth - cropBox.x;
                            cropBox.height = cropBox.width / cropRatio;
                        }
                    }
                }

                dragStartX = e.clientX;
                dragStartY = e.clientY;
            }

            updateCropOverlay();
        }

        function stopDragResize() {
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        }

        function updateCropOverlay() {
            const overlay = document.getElementById('cropOverlay');
            overlay.style.left = cropBox.x + 'px';
            overlay.style.top = cropBox.y + 'px';
            overlay.style.width = cropBox.width + 'px';
            overlay.style.height = cropBox.height + 'px';

            // æ›´æ–°è£å‰ªä¿¡æ¯
            const cropInfo = document.getElementById('cropInfo');
            cropInfo.textContent = `${Math.round(cropBox.width)} Ã— ${Math.round(cropBox.height)}`;
            cropInfo.style.display = 'block';
        }

        function applyCrop() {
            if (!currentImage) {
                showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œè£å‰ª
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = Math.round(cropBox.width);
            tempCanvas.height = Math.round(cropBox.height);
            const tempCtx = tempCanvas.getContext('2d');
            
            // ä»å½“å‰canvasè£å‰ª
            tempCtx.drawImage(
                currentCanvas,
                Math.round(cropBox.x),
                Math.round(cropBox.y),
                Math.round(cropBox.width),
                Math.round(cropBox.height),
                0,
                0,
                Math.round(cropBox.width),
                Math.round(cropBox.height)
            );

            // å°†è£å‰ªåçš„å›¾ç‰‡è½¬ä¸ºæ–°çš„Imageå¯¹è±¡
            tempCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    currentWidth = Math.round(cropBox.width);
                    currentHeight = Math.round(cropBox.height);
                    
                    // æ›´æ–°è¾“å…¥æ¡†
                    document.getElementById('widthInput').value = currentWidth;
                    document.getElementById('heightInput').value = currentHeight;
                    
                    drawCurrentImage();
                    URL.revokeObjectURL(url);
                    
                    // åˆ‡æ¢åˆ°è°ƒæ•´å¤§å°æ¨¡å¼
                    switchMode('resize');
                    showSuccess('è£å‰ªå·²åº”ç”¨ï¼å¯ä»¥ç»§ç»­è°ƒæ•´æˆ–è£å‰ª');
                };
                img.src = url;
            });
        }

        function selectFormat(format) {
            outputFormat = format;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ˜¾ç¤º/éšè—è´¨é‡æ»‘å—
            if (format === 'jpeg') {
                document.getElementById('qualitySlider').style.display = 'block';
            } else {
                document.getElementById('qualitySlider').style.display = 'none';
            }
            
            updateInfo();
        }

        function updateQuality(value) {
            quality = value / 100;
            document.getElementById('qualityValue').textContent = value + '%';
            updateInfo();
        }

        function downloadImage() {
            if (!currentImage) {
                showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            // ç›´æ¥ä½¿ç”¨å½“å‰canvaså¯¼å‡º
            const mimeType = outputFormat === 'jpeg' ? 'image/jpeg' : 'image/png';
            currentCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `image_${Date.now()}.${outputFormat}`;
                a.click();
                URL.revokeObjectURL(url);
                showSuccess('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼');
            }, mimeType, quality);
        }

        function resetAll() {
            currentImage = null;
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('mainContent').classList.remove('active');
            document.getElementById('fileInput').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('heightInput').value = '';
            document.getElementById('maxWidthInput').value = '';
            document.getElementById('maxHeightInput').value = '';
            currentMode = 'resize';
            document.getElementById('cropOverlay').style.display = 'none';
            document.getElementById('cropInfo').style.display = 'none';
            
            // é‡ç½®æ¨¡å¼æŒ‰é’®
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === 'resize') {
                    btn.classList.add('active');
                }
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = 'âœ… ' + message;
            successDiv.classList.add('show');
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
